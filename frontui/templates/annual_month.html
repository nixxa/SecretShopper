{% extends "layout.html" %}

{% block content %}
<h2>Отчет за {{model['date'].strftime('%B %Y')}}</h2>
<table class="table table-hover table-bordered" width="100%">
    <thead>
        <tr>
            <th style="min-width: 360px" colspan="2">Тайный покупатель</th>
            <th colspan="{{model['kiosks_count']}}">Киоск</th>
            <th colspan="{{model['shops_count']}}">АЗК с магазином</th>
            <th colspan="{{model['cafes_count']}}">АЗК с магазином и кафе</th>
        </tr>
        <tr>
            <th colspan="2">АЗС №</th>
            {% for item in model['kiosks'] %}
            <th style="min-width: 90px">{{item.num}}</th>
            {% endfor %}
            {% for item in model['shops'] %}
            <th colspan="2">{{item.num}}</th>
            {% endfor %}
            {% for item in model['cafes'] %}
            <th colspan="2">{{item.num}}</th>
            {% endfor %}
        </tr>
        <tr>
            <th colspan="2">Наименование</th>
            {% for item in model['kiosks'] %}
            <th>{{item.title}}</th>
            {% endfor %}
            {% for item in model['shops'] %}
            <th colspan="2">{{item.title}}</th>
            {% endfor %}
            {% for item in model['cafes'] %}
            <th colspan="2">{{item.title}}</th>
            {% endfor %}
        </tr>
        <!--<tr class="hidden">
            <th></th>
            <th></th>
            {% for item in model['kiosks'] %}
            <th></th>
            {% endfor %}
            {% for item in model['shops'] %}
            <th></th>
            <th></th>
            {% endfor %}
            {% for item in model['cafes'] %}
            <th></th>
            <th></th>
            {% endfor %}
        </tr>-->
    </thead>
    <tbody>
        <tr>
            <th colspan="2">Адрес</th>
            {% for item in model['kiosks'] %}
            <td><small>{{item.address}}</small></td>
            {% endfor %}
            {% for item in model['shops'] %}
            <td colspan="2"><small>{{item.address}}</small></td>
            {% endfor %}
            {% for item in model['cafes'] %}
            <td colspan="2"><small>{{item.address}}</small></td>
            {% endfor %}
        </tr>
        {% for question in model['checklist'].pages[0].questions %}
        <tr>
            <th colspan="2">{{ question.label }}</th>
            {% for item in model['kiosks'] %}
                {% if model[item.num] %}
                    <td class="nowrap">{{model[item.num][0][question.field_name]}}</td>
                {% else %}
                    <td></td>
                {% endif %}
            {% endfor %}
            {% for item in model['shops'] %}
                {% if model[item.num] %}
                    {% if model[item.num]|length > 0 %}
                    <td class="nowrap">{{model[item.num][0][question.field_name]}}</td>
                    {% else %}
                    <td></td><td></td>
                    {% endif %}
                    {% if model[item.num]|length > 1 %}
                    <td class="nowrap">{{model[item.num][1][question.field_name]}}</td>
                    {% else %}
                    <td></td>
                    {% endif %}
                {% else %}
                    <td></td>
                    <td></td>
                {% endif %}
            {% endfor %}
            {% for item in model['cafes'] %}
                {% if model[item.num] %}
                    {% if model[item.num]|length > 0 %}
                    <td class="nowrap">{{model[item.num][0][question.field_name]}}</td>
                    {% else %}
                    <td></td><td></td>
                    {% endif %}
                    {% if model[item.num]|length > 1 %}
                    <td class="nowrap">{{model[item.num][1][question.field_name]}}</td>
                    {% else %}
                    <td></td>
                    {% endif %}
                {% else %}
                    <td></td>
                    <td></td>
                {% endif %}
            {% endfor %}
        </tr>
        {% endfor %}
        <tr>
            <th colspan="2">Код проверяющего</th>
            {% for item in model['kiosks'] %}
            <td>тп</td>
            {% endfor %}
            {% for item in model['shops'] %}
            <td>тп</td><td>тп</td>
            {% endfor %}
            {% for item in model['cafes'] %}
            <td>тп</td><td>тп</td>
            {% endfor %}
        </tr>
        <tr>
            <th colspan="2">Оператор АЗС</th>
            {% for item in model['kiosks'] %}
                {% if model[item.num] %}
                    <td class="nowrap">{{model[item.num][0]['operator_fullname']}}</td>
                {% else %}
                    <td></td>
                {% endif %}
            {% endfor %}
            {% for item in model['shops'] %}
                {% if model[item.num] %}
                    {% if model[item.num]|length > 0 %}
                    <td class="nowrap">{{model[item.num][0]['operator_fullname']}}</td>
                    {% else %}
                    <td></td><td></td>
                    {% endif %}
                    {% if model[item.num]|length > 1 %}
                    <td class="nowrap">{{model[item.num][1]['operator_fullname']}}</td>
                    {% else %}
                    <td></td>
                    {% endif %}
                {% else %}
                    <td></td>
                    <td></td>
                {% endif %}
            {% endfor %}
            {% for item in model['cafes'] %}
                {% if model[item.num] %}
                    {% if model[item.num]|length > 0 %}
                    <td class="nowrap">{{model[item.num][0]['operator_fullname']}}</td>
                    {% else %}
                    <td></td><td></td>
                    {% endif %}
                    {% if model[item.num]|length > 1 %}
                    <td class="nowrap">{{model[item.num][1]['operator_fullname']}}</td>
                    {% else %}
                    <td></td>
                    {% endif %}
                {% else %}
                    <td></td>
                    <td></td>
                {% endif %}
            {% endfor %}
        </tr>
        <tr>
            <th colspan="2">Оператор-кассир</th>
            {% for item in model['kiosks'] %}
                {% if model[item.num] %}
                    <td class="nowrap">{{model[item.num][0]['accounter_fullname']}}</td>
                {% else %}
                    <td></td>
                {% endif %}
            {% endfor %}
            {% for item in model['shops'] %}
                {% if model[item.num] %}
                    {% if model[item.num]|length > 0 %}
                    <td class="nowrap">{{model[item.num][0]['accounter_fullname']}}</td>
                    {% else %}
                    <td></td><td></td>
                    {% endif %}
                    {% if model[item.num]|length > 1 %}
                    <td class="nowrap">{{model[item.num][1]['accounter_fullname']}}</td>
                    {% else %}
                    <td></td>
                    {% endif %}
                {% else %}
                    <td></td>
                    <td></td>
                {% endif %}
            {% endfor %}
            {% for item in model['cafes'] %}
                {% if model[item.num] %}
                    {% if model[item.num]|length > 0 %}
                    <td class="nowrap">{{model[item.num][0]['accounter_fullname']}} / {{model[item.num][0]['accounter_cafe_fullname']}}</td>
                    {% else %}
                    <td></td><td></td>
                    {% endif %}
                    {% if model[item.num]|length > 1 %}
                    <td class="nowrap">{{model[item.num][1]['accounter_fullname']}} / {{model[item.num][0]['accounter_cafe_fullname']}}</td>
                    {% else %}
                    <td></td>
                    {% endif %}
                {% else %}
                    <td></td>
                    <td></td>
                {% endif %}
            {% endfor %}
        </tr>
        <!-- pages -->
        {% for index in [1,2,3,4,5,6,7] %}
        <tr class="bg-success">
            <th>{{ index }}</th>
            <th>{{ model['checklist'].pages[index].title }}</th>
            {% for item in model['kiosks'] %}
                <th>{{ model['checklist'].pages[index].max_cost(item) }}</th>
            {% endfor %}
            {% for item in model['shops'] %}
                <th>{{ model['checklist'].pages[index].max_cost(item) }}</th>
                <th>{{ model['checklist'].pages[index].max_cost(item) }}</th>
            {% endfor %}
            {% for item in model['cafes'] %}
                <th>{{ model['checklist'].pages[index].max_cost(item) }}</th>
                <th>{{ model['checklist'].pages[index].max_cost(item) }}</th>
            {% endfor %}
        </tr>
        {% for question in model['checklist'].pages[index].questions %}
        <tr>
            {% set indx = loop.index %}
            <td>{{index}}.{{loop.index}}</td>
            <td>{{ question.label }}</td>
            {% for item in model['kiosks'] %}
                {% if model[item.num] %}
                    <td class="nowrap" title="пп: {{index}}.{{indx}}, АЗС: {{item.num}}-{{item.title}}">
                        {{model[item.num][0][question.field_name]|points(question)}}
                    </td>
                {% else %}
                    <td title="пп: {{index}}.{{indx}}, АЗС: {{item.num}}-{{item.title}}"></td>
                {% endif %}
            {% endfor %}
            {% for item in model['shops'] %}
                {% if model[item.num] %}
                    {% if model[item.num]|length > 0 %}
                    <td class="nowrap" title="пп: {{index}}.{{indx}}, АЗС: {{item.num}}-{{item.title}}">
                        {{model[item.num][0][question.field_name]|points(question)}}
                    </td>
                    {% else %}
                    <td title="пп: {{index}}.{{indx}}, АЗС: {{item.num}}-{{item.title}}"></td>
                    <td title="пп: {{index}}.{{indx}}, АЗС: {{item.num}}-{{item.title}}"></td>
                    {% endif %}
                    {% if model[item.num]|length > 1 %}
                    <td class="nowrap" title="пп: {{index}}.{{indx}}, АЗС: {{item.num}}-{{item.title}}">
                        {{model[item.num][1][question.field_name]|points(question)}}
                    </td>
                    {% else %}
                    <td title="пп: {{index}}.{{indx}}, АЗС: {{item.num}}-{{item.title}}"></td>
                    {% endif %}
                {% else %}
                    <td title="пп: {{index}}.{{indx}}, АЗС: {{item.num}}-{{item.title}}"></td>
                    <td title="пп: {{index}}.{{indx}}, АЗС: {{item.num}}-{{item.title}}"></td>
                {% endif %}
            {% endfor %}
            {% for item in model['cafes'] %}
                {% if model[item.num] %}
                    {% if model[item.num]|length > 0 %}
                    <td class="nowrap" title="пп: {{index}}.{{indx}}, АЗС: {{item.num}}-{{item.title}}">
                        {{model[item.num][0][question.field_name]|points(question)}}
                    </td>
                    {% else %}
                    <td title="пп: {{index}}.{{indx}}, АЗС: {{item.num}}-{{item.title}}"></td>
                    <td title="пп: {{index}}.{{indx}}, АЗС: {{item.num}}-{{item.title}}"></td>
                    {% endif %}
                    {% if model[item.num]|length > 1 %}
                    <td class="nowrap" title="пп: {{index}}.{{indx}}, АЗС: {{item.num}}-{{item.title}}">
                        {{model[item.num][1][question.field_name]|points(question)}}
                    </td>
                    {% else %}
                    <td title="пп: {{index}}.{{indx}}, АЗС: {{item.num}}-{{item.title}}"></td>
                    {% endif %}
                {% else %}
                    <td title="пп: {{index}}.{{indx}}, АЗС: {{item.num}}-{{item.title}}"></td>
                    <td title="пп: {{index}}.{{indx}}, АЗС: {{item.num}}-{{item.title}}"></td>
                {% endif %}
            {% endfor %}
        </tr>
        {% endfor %}
        {% endfor %}
    </tbody>
    <tfoot>
        <tr>
            <th colspan="2" class="text-right">Максимальный балл</th>
            {% for item in model['kiosks'] %}
                {% if model[item.num] %}
                    <td title="MAX, АЗС: {{item.num}}-{{item.title}}">
                        {{model[item.num][0]['max_points']}}
                    </td>
                {% else %}
                    <td title="MAX, АЗС: {{item.num}}-{{item.title}}"></td>
                {% endif %}
            {% endfor %}
            {% for item in model['shops'] %}
            {% if model[item.num] %}
                {% if model[item.num]|length > 0 %}
                    <td title="MAX, АЗС: {{item.num}}-{{item.title}}">
                       {{model[item.num][0]['max_points']}}
                    </td>
                    {% else %}
                    <td title="MAX, АЗС: {{item.num}}-{{item.title}}"></td>
                    <td title="MAX, АЗС: {{item.num}}-{{item.title}}"></td>
                    {% endif %}
                    {% if model[item.num]|length > 1 %}
                    <td title="MAX, АЗС: {{item.num}}-{{item.title}}">
                        {{model[item.num][1]['max_points']}}
                    </td>
                    {% else %}
                    <td title="MAX, АЗС: {{item.num}}-{{item.title}}"></td>
                    {% endif %}
                {% else %}
                    <td title="MAX, АЗС: {{item.num}}-{{item.title}}"></td>
                    <td title="MAX, АЗС: {{item.num}}-{{item.title}}"></td>
                {% endif %}
            {% endfor %}
            {% for item in model['cafes'] %}
            {% if model[item.num] %}
                {% if model[item.num]|length > 0 %}
                    <td title="MAX, АЗС: {{item.num}}-{{item.title}}">
                        {{model[item.num][0]['max_points']}}
                    </td>
                    {% else %}
                    <td title="MAX, АЗС: {{item.num}}-{{item.title}}"></td>
                    <td title="MAX, АЗС: {{item.num}}-{{item.title}}"></td>
                    {% endif %}
                    {% if model[item.num]|length > 1 %}
                    <td title="MAX, АЗС: {{item.num}}-{{item.title}}">
                        {{model[item.num][1]['max_points']}}
                    </td>
                    {% else %}
                    <td title="MAX, АЗС: {{item.num}}-{{item.title}}"></td>
                    {% endif %}
                {% else %}
                    <td title="MAX, АЗС: {{item.num}}-{{item.title}}"></td>
                    <td title="MAX, АЗС: {{item.num}}-{{item.title}}"></td>
                {% endif %}
            {% endfor %}
        </tr>
        <tr>
            <th colspan="2" class="text-right">Балл по проверке</th>
            {% for item in model['kiosks'] %}
                {% if model[item.num] %}
                    <td title="MAX, АЗС: {{item.num}}-{{item.title}}">
                        {{model[item.num][0]['points']}}
                    </td>
                {% else %}
                    <td title="MAX, АЗС: {{item.num}}-{{item.title}}"></td>
                {% endif %}
            {% endfor %}
            {% for item in model['shops'] %}
            {% if model[item.num] %}
                {% if model[item.num]|length > 0 %}
                    <td title="MAX, АЗС: {{item.num}}-{{item.title}}">
                       {{model[item.num][0]['points']}}
                    </td>
                    {% else %}
                    <td title="MAX, АЗС: {{item.num}}-{{item.title}}"></td>
                    <td title="MAX, АЗС: {{item.num}}-{{item.title}}"></td>
                    {% endif %}
                    {% if model[item.num]|length > 1 %}
                    <td title="MAX, АЗС: {{item.num}}-{{item.title}}">
                        {{model[item.num][1]['points']}}
                    </td>
                    {% else %}
                    <td title="MAX, АЗС: {{item.num}}-{{item.title}}"></td>
                    {% endif %}
                {% else %}
                    <td title="MAX, АЗС: {{item.num}}-{{item.title}}"></td>
                    <td title="MAX, АЗС: {{item.num}}-{{item.title}}"></td>
                {% endif %}
            {% endfor %}
            {% for item in model['cafes'] %}
            {% if model[item.num] %}
                {% if model[item.num]|length > 0 %}
                    <td title="MAX, АЗС: {{item.num}}-{{item.title}}">
                        {{model[item.num][0]['points']}}
                    </td>
                    {% else %}
                    <td title="MAX, АЗС: {{item.num}}-{{item.title}}"></td>
                    <td title="MAX, АЗС: {{item.num}}-{{item.title}}"></td>
                    {% endif %}
                    {% if model[item.num]|length > 1 %}
                    <td title="MAX, АЗС: {{item.num}}-{{item.title}}">
                        {{model[item.num][1]['points']}}
                    </td>
                    {% else %}
                    <td title="MAX, АЗС: {{item.num}}-{{item.title}}"></td>
                    {% endif %}
                {% else %}
                    <td title="MAX, АЗС: {{item.num}}-{{item.title}}"></td>
                    <td title="MAX, АЗС: {{item.num}}-{{item.title}}"></td>
                {% endif %}
            {% endfor %}
        </tr>
        <tr>
            <th colspan="2" class="text-right">%</th>
            {% for item in model['kiosks'] %}
                {% if model[item.num] %}
                    <td title="MAX, АЗС: {{item.num}}-{{item.title}}">
                        {{ '{:.0f}%'.format(model[item.num][0]['points_percent']) }}
                    </td>
                {% else %}
                    <td title="MAX, АЗС: {{item.num}}-{{item.title}}"></td>
                {% endif %}
            {% endfor %}
            {% for item in model['shops'] %}
            {% if model[item.num] %}
                {% if model[item.num]|length > 0 %}
                    <td title="MAX, АЗС: {{item.num}}-{{item.title}}">
                       {{'{:.0f}%'.format(model[item.num][0]['points_percent'])}}
                    </td>
                    {% else %}
                    <td title="MAX, АЗС: {{item.num}}-{{item.title}}"></td>
                    <td title="MAX, АЗС: {{item.num}}-{{item.title}}"></td>
                    {% endif %}
                    {% if model[item.num]|length > 1 %}
                    <td title="MAX, АЗС: {{item.num}}-{{item.title}}">
                        {{'{:.0f}%'.format(model[item.num][1]['points_percent'])}}
                    </td>
                    {% else %}
                    <td title="MAX, АЗС: {{item.num}}-{{item.title}}"></td>
                    {% endif %}
                {% else %}
                    <td title="MAX, АЗС: {{item.num}}-{{item.title}}"></td>
                    <td title="MAX, АЗС: {{item.num}}-{{item.title}}"></td>
                {% endif %}
            {% endfor %}
            {% for item in model['cafes'] %}
            {% if model[item.num] %}
                {% if model[item.num]|length > 0 %}
                    <td title="MAX, АЗС: {{item.num}}-{{item.title}}">
                        {{'{:.0f}%'.format(model[item.num][0]['points_percent'])}}
                    </td>
                    {% else %}
                    <td title="MAX, АЗС: {{item.num}}-{{item.title}}"></td>
                    <td title="MAX, АЗС: {{item.num}}-{{item.title}}"></td>
                    {% endif %}
                    {% if model[item.num]|length > 1 %}
                    <td title="MAX, АЗС: {{item.num}}-{{item.title}}">
                        {{'{:.0f}%'.format(model[item.num][1]['points_percent'])}}
                    </td>
                    {% else %}
                    <td title="MAX, АЗС: {{item.num}}-{{item.title}}"></td>
                    {% endif %}
                {% else %}
                    <td title="MAX, АЗС: {{item.num}}-{{item.title}}"></td>
                    <td title="MAX, АЗС: {{item.num}}-{{item.title}}"></td>
                {% endif %}
            {% endfor %}
        </tr>
    </tfoot>
</table>
{% endblock %}

{% block scripts %}
<script type="text/javascript">
    require(['jquery', 'datatables'], function ($, dt) {
        // $(document).ready(function() {
        //     $('table').DataTable({
        //         scrollY:        '400px',
        //         scrollX:        true,
        //         scrollCollapse: true,
        //         fixedColumns:   { leftColumns: 2 },
        //         paging:         false,
        //         ordering:       false,
        //         info:           false,
        //         searching:      false
        //     });
        // });
    });
</script>
{% endblock %}